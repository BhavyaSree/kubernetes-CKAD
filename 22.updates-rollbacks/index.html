<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        
        <meta name="author" content="Bhavya Sree Bindela">
        <link rel="canonical" href="https://bhavyasree.github.io/Kubernetes-CKAD/22.updates-rollbacks/">
        <link rel="shortcut icon" href="../img/favicon.ico">
        <title>Upgrades-Rollbacks - Kubernetes-CKAD</title>
        <link href="../css/bootstrap.min.css" rel="stylesheet">
        <link href="../css/font-awesome.min.css" rel="stylesheet">
        <link href="../css/base.css" rel="stylesheet">
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/obsidian.min.css">

        <script src="../js/jquery-1.10.2.min.js" defer></script>
        <script src="../js/bootstrap.min.js" defer></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js"></script>
        <script>hljs.initHighlightingOnLoad();</script> 
    </head>

    <body>
        <div class="navbar fixed-top navbar-expand-lg navbar-dark bg-primary">
            <div class="container">
                <a class="navbar-brand" href="..">Kubernetes-CKAD</a>
                <!-- Expander button -->
                <button type="button" class="navbar-toggler" data-toggle="collapse" data-target="#navbar-collapse">
                    <span class="navbar-toggler-icon"></span>
                </button>

                <!-- Expanded navigation -->
                <div id="navbar-collapse" class="navbar-collapse collapse">
                        <!-- Main navigation -->
                        <ul class="nav navbar-nav">
                            <li class="navitem">
                                <a href=".." class="nav-link">Getting started</a>
                            </li>
                            <li class="dropdown active">
                                <a href="#" class="nav-link dropdown-toggle" data-toggle="dropdown">Documentation <b class="caret"></b></a>
                                <ul class="dropdown-menu">
                                    
<li>
    <a href="../01.kubernetes-architecture/" class="dropdown-item">Architecture</a>
</li>
                                    
<li>
    <a href="../02.imperative-commands/" class="dropdown-item">Imperative Commands</a>
</li>
                                    
<li>
    <a href="../03.formatting-output-with-kubectl/" class="dropdown-item">Output Format</a>
</li>
                                    
<li>
    <a href="../04.questions-1/" class="dropdown-item">Examples</a>
</li>
                                    
<li>
    <a href="../05.configuration-commands/" class="dropdown-item">Commands</a>
</li>
                                    
<li>
    <a href="../06.edit-pods-deploys/" class="dropdown-item">Edit POD & Deploy</a>
</li>
                                    
<li>
    <a href="../07.configuration-env/" class="dropdown-item">Env variables</a>
</li>
                                    
<li>
    <a href="../08.configMaps/" class="dropdown-item">ConfigMap</a>
</li>
                                    
<li>
    <a href="../09.secrets/" class="dropdown-item">Secret</a>
</li>
                                    
<li>
    <a href="../10.security/" class="dropdown-item">Security</a>
</li>
                                    
<li>
    <a href="../11.kubernetes-security/" class="dropdown-item">K8-Security</a>
</li>
                                    
<li>
    <a href="../12.service-account/" class="dropdown-item">Service Account</a>
</li>
                                    
<li>
    <a href="../13.resource-requirements/" class="dropdown-item">Resources</a>
</li>
                                    
<li>
    <a href="../14.taints-tolerations/" class="dropdown-item">Taints & Tolerations</a>
</li>
                                    
<li>
    <a href="../15.node-selectors-affinity/" class="dropdown-item">NodeSelectors & Affinity</a>
</li>
                                    
<li>
    <a href="../16.taints%26tolerations-Vs-nodeaffinity/" class="dropdown-item">T&T/NodeAffinity</a>
</li>
                                    
<li>
    <a href="../17.multi-container-pods/" class="dropdown-item">MultiContainer pod</a>
</li>
                                    
<li>
    <a href="../18.readiness-liveness/" class="dropdown-item">Readiness-Liveliness</a>
</li>
                                    
<li>
    <a href="../19.container-logging/" class="dropdown-item">Logging</a>
</li>
                                    
<li>
    <a href="../20.monitoring/" class="dropdown-item">Monitoring</a>
</li>
                                    
<li>
    <a href="../21.labels-selectors-annotations/" class="dropdown-item">Selectors</a>
</li>
                                    
<li>
    <a href="./" class="dropdown-item active">Upgrades-Rollbacks</a>
</li>
                                    
<li>
    <a href="../23.jobs/" class="dropdown-item">Jobs</a>
</li>
                                    
<li>
    <a href="../24.services/" class="dropdown-item">Services</a>
</li>
                                    
<li>
    <a href="../25.Ingress/" class="dropdown-item">Ingress</a>
</li>
                                    
<li>
    <a href="../26.network-policies/" class="dropdown-item">Network Policy</a>
</li>
                                    
<li>
    <a href="../27.volumes/" class="dropdown-item">volumes</a>
</li>
                                    
<li>
    <a href="../28.refernce/" class="dropdown-item">Points</a>
</li>
                                </ul>
                            </li>
                            <li class="dropdown">
                                <a href="#" class="nav-link dropdown-toggle" data-toggle="dropdown">Help <b class="caret"></b></a>
                                <ul class="dropdown-menu">
                                    
<li>
    <a href="../KodeKloud-Kubernetes%2B-CKAD.pdf" class="dropdown-item">Guide</a>
</li>
                                </ul>
                            </li>
                        </ul>

                    <ul class="nav navbar-nav ml-auto">
                        <li class="nav-item">
                            <a href="#" class="nav-link" data-toggle="modal" data-target="#mkdocs_search_modal">
                                <i class="fa fa-search"></i> Search
                            </a>
                        </li>
                            <li class="nav-item">
                                <a rel="prev" href="../21.labels-selectors-annotations/" class="nav-link">
                                    <i class="fa fa-arrow-left"></i> Previous
                                </a>
                            </li>
                            <li class="nav-item">
                                <a rel="next" href="../23.jobs/" class="nav-link">
                                    Next <i class="fa fa-arrow-right"></i>
                                </a>
                            </li>
                            <li class="nav-item">
                                <a href="https://github.com/BhavyaSree/kubernetes-CKAD/edit/master/docs/22.updates-rollbacks.md" class="nav-link"><i class="fa fa-github"></i> Edit on GitHub</a>
                            </li>
                    </ul>
                </div>
            </div>
        </div>

        <div class="container">
            <div class="row">
                    <div class="col-md-3"><div class="navbar-light navbar-expand-md bs-sidebar hidden-print affix" role="complementary">
    <div class="navbar-header">
        <button type="button" class="navbar-toggler collapsed" data-toggle="collapse" data-target="#toc-collapse" title="Table of Contents">
            <span class="fa fa-angle-down"></span>
        </button>
    </div>

    
    <div id="toc-collapse" class="navbar-collapse collapse card bg-secondary">
        <ul class="nav flex-column">
            
            <li class="nav-item" data-level="2"><a href="#rollout-and-versioning" class="nav-link">Rollout and Versioning</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            
            <li class="nav-item" data-level="2"><a href="#deployment-strategy" class="nav-link">Deployment Strategy</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            
            <li class="nav-item" data-level="2"><a href="#upgrades" class="nav-link">Upgrades</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            
            <li class="nav-item" data-level="2"><a href="#rollback" class="nav-link">Rollback</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            
            <li class="nav-item" data-level="2"><a href="#commands" class="nav-link">Commands</a>
              <ul class="nav flex-column">
              </ul>
            </li>
        </ul>
    </div>
</div></div>
                    <div class="col-md-9" role="main">

<h2 id="rollout-and-versioning">Rollout and Versioning</h2>
<p>When we first create a deployment, it triggers a rollout, a new rollout creates a new deployment revision. Let's call it revision 1.<br />
In future, when the application is upgraded i.e., container version is updated with a new image, a new rollout is triggered and a new deployment revision is created named revision2.<br />
This helps us to keep track the changes made to our deployment and enables us to rollback to the previson versions of deployment if necessary.  </p>
<p>To see the status of the rollout <br />
<code>kubectl rollout status &lt;deployment name&gt;</code>  </p>
<p>To see the revisions and history of rollout<br />
<code>kubectl rollout history &lt;deployment name&gt;</code><br />
This will show the revisions and history of our deployment  </p>
<h2 id="deployment-strategy">Deployment Strategy</h2>
<p>There are two types of deployment strategies.<br />
* When we have multiple replicas of web application instance deployed, one way to upgrade these to a newer version is to destroy all of these and then create newer versions of application instances.<br />
The problem with this is, for the period between the older version is down and newer version is up, the application is down and inaccessible to the users. This strategy is called <code>recreate strategy</code> and this is not the actual deployment strategy.  </p>
<ul>
<li>In the second strategy, we don't destroy all the instances once. Instead, we take down the older version and bring up a newer version one by one. This way the application never goes down and the upgrade is seemless. This is called <code>rollout strategy</code>.  If we do not specify a strategy while creating a deployment, by default it assumes the deployment strategy as <code>rolling update</code>.<br />
<code>Rolling update</code> is the default deployment strategy.  </li>
</ul>
<p>Updating the deployment means like updating the container version, updating labels, updating number of replicas. We can modify these in the deployment efinition file. Once we make necessary changes we run<br />
<code>kubectl apply -f &lt;deployment definition filename&gt;</code>  to apply the changes.<br />
A new rollout is triggered and a new revision of the deployment is created.  </p>
<p>To update the image of the application, we can use<br />
<code>kubectl set image deployment &lt;deploymentname&gt; &lt;podname&gt;=&lt;newimage&gt;</code> <br />
If we do like this, the configurations will be different in the definition file, so we need to be careful when we use the same definition file in future for changes.  </p>
<p>To see the detailed information regarding deployments<br />
<code>kubectl describe deployment &lt;deploymentname&gt;</code><br />
We will notice, when the recreate strategy is used, the old replicas are scaled down to 0 first and then the new replicas are scaled up. <br />
However, when the rolling update strategy is used, the old replicaset is scaled down one at a time, simultaneously scaling up the new replicaset one at a time.  </p>
<h2 id="upgrades">Upgrades</h2>
<p>When the new deployment is created, say to deploy 5 replicas. If first creates a replicaset automatically, which in turn creates the number of pods required to meet the number of replicas. <br />
When we upgrade our application, the kubernetes deployment object creates a new replicaset under the hoods and starts deploying the containers there. At the same time, taking down the pods from the old replicaset following a rolling update strategy.  <br />
This can be seen using <code>kubectl get replicasets</code>  </p>
<p><img alt="replicasets" src="../Screens/replicasets.png" />  </p>
<h2 id="rollback">Rollback</h2>
<p>For Example, once we upgrade our application, we realize something is wrong with the new version of the build we used to upgrade. So, we would like to rollback our update.<br />
To rollback to the previous revision or to undo a change<br />
<code>kubectl rollout undo deployment &lt;deploymentname&gt;</code><br />
The deployment then destroy the pods in the new replicaset and bring the older ones up in the old replicaset. Then the application is back to older format.  </p>
<p><img alt="rollback" src="../Screens/rollback.png" />  </p>
<h2 id="commands">Commands</h2>
<p><img alt="commands" src="../Screens/commands.png" /></p>
<p>We can check the status of each revision individually by using the --revision flag<br />
<code>kubectl rollout history deployment &lt;deploymentname&gt; --revision=&lt;number&gt;</code>  </p>
<p>Normally, the <code>change-cause</code> field will be empty in the rollout history.<br />
We can use the <code>--record</code> flag to save the command used to create/update a deployment against the revision number.
<code>kubectl set image deployment &lt;deploymentname&gt; &lt;podname&gt;=&lt;newimage&gt; --record</code>  </p></div>
            </div>
        </div>

        <footer class="col-md-12">
            <hr>
                <p>Copyright &copy; 2020 <a href="https://www.linkedin.com/in/bhavyabindela/">Bhavya Sree Bindela</a>.</p>
            <p>Documentation built with <a href="https://www.mkdocs.org/">MkDocs</a>.</p>
        </footer>
        <script>
            var base_url = "..",
                shortcuts = {"help": 191, "next": 78, "previous": 80, "search": 83};
        </script>
        <script src="../js/base.js" defer></script>
        <script src="../search/main.js" defer></script>

        <div class="modal" id="mkdocs_search_modal" tabindex="-1" role="dialog" aria-labelledby="searchModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="searchModalLabel">Search</h4>
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
            </div>
            <div class="modal-body">
                <p>
                    From here you can search these documents. Enter
                    your search terms below.
                </p>
                <form>
                    <div class="form-group">
                        <input type="search" class="form-control" placeholder="Search..." id="mkdocs-search-query" title="Type search term here">
                    </div>
                </form>
                <div id="mkdocs-search-results"></div>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div><div class="modal" id="mkdocs_keyboard_modal" tabindex="-1" role="dialog" aria-labelledby="keyboardModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="keyboardModalLabel">Keyboard Shortcuts</h4>
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
            </div>
            <div class="modal-body">
              <table class="table">
                <thead>
                  <tr>
                    <th style="width: 20%;">Keys</th>
                    <th>Action</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td class="help shortcut"><kbd>?</kbd></td>
                    <td>Open this help</td>
                  </tr>
                  <tr>
                    <td class="next shortcut"><kbd>n</kbd></td>
                    <td>Next page</td>
                  </tr>
                  <tr>
                    <td class="prev shortcut"><kbd>p</kbd></td>
                    <td>Previous page</td>
                  </tr>
                  <tr>
                    <td class="search shortcut"><kbd>s</kbd></td>
                    <td>Search</td>
                  </tr>
                </tbody>
              </table>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div>

    </body>
</html>
